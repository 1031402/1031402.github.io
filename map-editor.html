<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>SOOP 매핑 에디터</title>
  <style>
    body { background:#111; color:#fff; font-family:sans-serif; padding:20px; }
    h2 { margin-bottom:20px; }
    textarea { width:100%; height:300px; font-family:monospace; padding:10px; }
    button { margin-top:10px; padding:8px 14px; cursor:pointer; font-size:14px; }
  </style>
</head>
<body>
  <h2>📝 SOOP 매핑 수정기</h2>
  <p>아래 JSON을 수정 후 <b>저장</b>을 누르면 <code>map.json</code>이 업데이트됩니다.</p>

  <textarea id="editor"></textarea>
  <br>
  <button onclick="saveToGitHub()">☁ GitHub에 저장</button>

  <script>
    // ===== GitHub 설정 =====
    const owner   = "lakeminbab";         // 깃허브 아이디
    const repo    = "jundori";      // 저장소 이름
    const path    = "map.json";        // 파일 경로
    const branch  = "main";            // 기본 브랜치
    const token   = "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"; // 본인 Personal Access Token

    // ===== 파일 불러오기 =====
    async function loadFile() {
      const res = await fetch(`https://raw.githubusercontent.com/${owner}/${repo}/${branch}/${path}`);
      if (res.ok) {
        const text = await res.text();
        document.getElementById("editor").value = text;
      } else {
        alert("⚠ map.json 불러오기 실패");
      }
    }

    // ===== GitHub에 저장 =====
    async function saveToGitHub() {
      const content = document.getElementById("editor").value;
      let contentBase64 = btoa(unescape(encodeURIComponent(content)));

      // 1) 현재 파일 sha 가져오기
      const metaRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}?ref=${branch}`, {
        headers: { "Authorization": `token ${token}` }
      });
      const meta = await metaRes.json();
      const sha = meta.sha;

      // 2) 파일 업데이트
      const commitMessage = `Update map.json via map-editor (${new Date().toISOString()})`;
      try {
        const putRes = await fetch(`https://api.github.com/repos/${owner}/${repo}/contents/${path}`, {
          method: "PUT",
          headers: { 
            "Authorization": `token ${token}`,
            "Content-Type":"application/json",
            "Accept":"application/vnd.github+json"
          },
          body: JSON.stringify({
            message: commitMessage,
            content: contentBase64,
            sha: sha,
            branch: branch
          })
        });
        const putData = await putRes.json();
        if (putRes.ok) {
          // 저장 성공 시 사용자 선택
          const ghPagesUrl = `https://${owner}.github.io/${repo}/index.html`;
          if (confirm("✅ GitHub에 저장되었습니다!\n\n👉 index.html로 이동할까요?")) {
            location.href = ghPagesUrl;  // 현재 창에서 index.html로 이동
          } else {
            alert("✔ 저장 완료! (현재 페이지에 머무릅니다)");
          }
        } else {
          alert("GitHub 저장 실패: " + (putData.message || JSON.stringify(putData)));
        }
      } catch (err) {
        alert("GitHub 저장 중 오류 발생: " + err.message);
      }
    }

    // 실행 시 자동 불러오기
    loadFile();
  </script>
</body>
</html>
